<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>feed.rb</title>
  <link rel="stylesheet" href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div id="jump_to">
    Jump To &hellip;
    <div id="jump_wrapper">
      <div id="jump_page">
          <a class="source" href="../controllers/application_controller.html">application_controller.rb</a>
          <a class="source" href="../controllers/auth_controller.html">auth_controller.rb</a>
          <a class="source" href="../controllers/feeds_controller.html">feeds_controller.rb</a>
          <a class="source" href="../controllers/salmon_controller.html">salmon_controller.rb</a>
          <a class="source" href="../controllers/searches_controller.html">searches_controller.rb</a>
          <a class="source" href="../controllers/sessions_controller.html">sessions_controller.rb</a>
          <a class="source" href="../controllers/static_controller.html">static_controller.rb</a>
          <a class="source" href="../controllers/subscriptions_controller.html">subscriptions_controller.rb</a>
          <a class="source" href="../controllers/updates_controller.html">updates_controller.rb</a>
          <a class="source" href="../controllers/users_controller.html">users_controller.rb</a>
          <a class="source" href="../controllers/webfinger_controller.html">webfinger_controller.rb</a>
          <a class="source" href="author.html">author.rb</a>
          <a class="source" href="authorization.html">authorization.rb</a>
          <a class="source" href="feed.html">feed.rb</a>
          <a class="source" href="notifier.html">notifier.rb</a>
          <a class="source" href="update.html">update.rb</a>
          <a class="source" href="user.html">user.rb</a>
      </div>
    </div>
  </div>
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>feed.rb</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-1'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-1">&#182;</a>
        </div>
        <p>Feeds are pretty central to everything. They&rsquo;re a representation of a PuSH
enabled Atom feed. Every user has a feed of their updates, we keep feeds
for remote users that our users are subscribed to, and maybe even other
things in the future, like hashtags.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="k">class</span> <span class="nc">Feed</span></pre></div>
      </td>
    </tr>
    <tr id='section-2'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-2">&#182;</a>
        </div>
        <p>XXX: Are these even needed? Bundler should be require-ing them.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="nb">require</span> <span class="s1">&#39;osub&#39;</span>
  <span class="nb">require</span> <span class="s1">&#39;opub&#39;</span>
  <span class="nb">require</span> <span class="s1">&#39;nokogiri&#39;</span>
  <span class="nb">require</span> <span class="s1">&#39;atom&#39;</span>

  <span class="kp">include</span> <span class="no">MongoMapper</span><span class="o">::</span><span class="no">Document</span></pre></div>
      </td>
    </tr>
    <tr id='section-3'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-3">&#182;</a>
        </div>
        <p>Feed url (and an indicator that it is local if this is nil)</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">key</span> <span class="ss">:remote_url</span><span class="p">,</span> <span class="nb">String</span></pre></div>
      </td>
    </tr>
    <tr id='section-4'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-4">&#182;</a>
        </div>
        <p>OStatus subscriber information</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">key</span> <span class="ss">:verify_token</span><span class="p">,</span> <span class="nb">String</span>
  <span class="n">key</span> <span class="ss">:secret</span><span class="p">,</span> <span class="nb">String</span></pre></div>
      </td>
    </tr>
    <tr id='section-5'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-5">&#182;</a>
        </div>
        <p>For both pubs and subs, it needs to know what hubs the feed is in
communication with in order to control pub/sub operations</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">key</span> <span class="ss">:hubs</span><span class="p">,</span> <span class="nb">Array</span>

  <span class="n">belongs_to</span> <span class="ss">:author</span>
  <span class="n">key</span> <span class="ss">:author_id</span><span class="p">,</span> <span class="no">ObjectId</span>

  <span class="n">many</span> <span class="ss">:updates</span>

  <span class="n">timestamps!</span>

  <span class="n">after_create</span> <span class="ss">:default_hubs</span></pre></div>
      </td>
    </tr>
    <tr id='section-6'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-6">&#182;</a>
        </div>
        <p>This is because sometimes the mongomapper association returns nil
even though there is an author_id and the Author exists; see Issue #421</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nf">author</span>
    <span class="no">Author</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">author_id</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">populate</span><span class="p">(</span><span class="n">xrd</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-7'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-7">&#182;</a>
        </div>
        <p>TODO: More entropy would be nice</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nb">self</span><span class="o">.</span><span class="n">verify_token</span> <span class="o">=</span> <span class="no">Digest</span><span class="o">::</span><span class="no">MD5</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">(</span><span class="nb">rand</span><span class="o">.</span><span class="n">to_s</span><span class="p">)</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">secret</span> <span class="o">=</span> <span class="no">Digest</span><span class="o">::</span><span class="no">MD5</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">(</span><span class="nb">rand</span><span class="o">.</span><span class="n">to_s</span><span class="p">)</span>

    <span class="n">ostatus_feed</span> <span class="o">=</span> <span class="no">OStatus</span><span class="o">::</span><span class="no">Feed</span><span class="o">.</span><span class="n">from_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

    <span class="n">avatar_url</span> <span class="o">=</span> <span class="n">ostatus_feed</span><span class="o">.</span><span class="n">icon</span>
    <span class="k">if</span> <span class="n">avatar_url</span> <span class="o">==</span> <span class="kp">nil</span>
      <span class="n">avatar_url</span> <span class="o">=</span> <span class="n">ostatus_feed</span><span class="o">.</span><span class="n">logo</span>
    <span class="k">end</span>

    <span class="n">a</span> <span class="o">=</span> <span class="n">ostatus_feed</span><span class="o">.</span><span class="n">author</span>

    <span class="nb">self</span><span class="o">.</span><span class="n">author</span> <span class="o">=</span> <span class="no">Author</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="n">a</span><span class="o">.</span><span class="n">portable_contacts</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span>
                                <span class="ss">:username</span> <span class="o">=&gt;</span> <span class="n">a</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="n">a</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
                                <span class="ss">:remote_url</span> <span class="o">=&gt;</span> <span class="n">a</span><span class="o">.</span><span class="n">uri</span><span class="p">,</span>
                                <span class="ss">:salmon_url</span> <span class="o">=&gt;</span> <span class="n">ostatus_feed</span><span class="o">.</span><span class="n">salmon</span><span class="p">,</span>
                                <span class="ss">:bio</span> <span class="o">=&gt;</span> <span class="n">a</span><span class="o">.</span><span class="n">portable_contacts</span><span class="o">.</span><span class="n">note</span><span class="p">,</span>
                                <span class="ss">:image_url</span> <span class="o">=&gt;</span> <span class="n">avatar_url</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">xrd</span></pre></div>
      </td>
    </tr>
    <tr id='section-8'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-8">&#182;</a>
        </div>
        <p>Retrieve the public key</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">public_key</span> <span class="o">=</span> <span class="n">xrd</span><span class="o">.</span><span class="n">links</span><span class="o">.</span><span class="n">find</span> <span class="p">{</span> <span class="o">|</span><span class="n">l</span><span class="o">|</span> <span class="n">l</span><span class="o">[</span><span class="s1">&#39;rel&#39;</span><span class="o">].</span><span class="n">downcase</span> <span class="o">==</span> <span class="s1">&#39;magic-public-key&#39;</span> <span class="p">}</span>
      <span class="n">public_key</span> <span class="o">=</span> <span class="n">public_key</span><span class="o">.</span><span class="n">href</span><span class="o">[/^.</span><span class="n">*</span><span class="sc">?,</span><span class="p">(</span><span class="o">.</span><span class="n">*</span><span class="p">)</span><span class="vg">$/</span><span class="p">,</span><span class="mi">1</span><span class="o">]</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">public_key</span> <span class="o">=</span> <span class="n">public_key</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">reset_key_lease</span></pre></div>
      </td>
    </tr>
    <tr id='section-9'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-9">&#182;</a>
        </div>
        <p>Salmon URL</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nb">self</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">salmon_url</span> <span class="o">=</span> <span class="n">xrd</span><span class="o">.</span><span class="n">links</span><span class="o">.</span><span class="n">find</span> <span class="p">{</span> <span class="o">|</span><span class="n">l</span><span class="o">|</span> <span class="n">l</span><span class="o">[</span><span class="s1">&#39;rel&#39;</span><span class="o">].</span><span class="n">downcase</span> <span class="o">==</span> <span class="s1">&#39;salmon&#39;</span> <span class="p">}</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">save</span>
    <span class="k">end</span>

    <span class="nb">self</span><span class="o">.</span><span class="n">hubs</span> <span class="o">=</span> <span class="n">ostatus_feed</span><span class="o">.</span><span class="n">hubs</span>

    <span class="n">save</span></pre></div>
      </td>
    </tr>
    <tr id='section-10'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-10">&#182;</a>
        </div>
        <p>Save the first 3 updates in our feed</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">entries</span> <span class="o">=</span> <span class="n">ostatus_feed</span><span class="o">.</span><span class="n">entries</span>

    <span class="k">if</span> <span class="n">entries</span><span class="o">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">3</span>
      <span class="n">entries</span> <span class="o">=</span> <span class="n">entries</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">2</span><span class="o">]</span>
    <span class="k">end</span>
    <span class="n">populate_entries</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>

    <span class="n">save</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">populate_entries</span><span class="p">(</span><span class="n">os_entries</span><span class="p">)</span>
    <span class="n">os_entries</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">entry</span><span class="o">|</span>
      <span class="n">u</span> <span class="o">=</span> <span class="no">Update</span><span class="o">.</span><span class="n">first</span><span class="p">(</span><span class="ss">:url</span> <span class="o">=&gt;</span> <span class="n">entry</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
      <span class="n">new_update</span> <span class="o">=</span> <span class="kp">false</span>
      <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">nil?</span>
        <span class="n">new_update</span> <span class="o">=</span> <span class="kp">true</span>
        <span class="n">u</span> <span class="o">=</span> <span class="no">Update</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:author</span> <span class="o">=&gt;</span> <span class="nb">self</span><span class="o">.</span><span class="n">author</span><span class="p">,</span>
                       <span class="ss">:created_at</span> <span class="o">=&gt;</span> <span class="n">entry</span><span class="o">.</span><span class="n">published</span><span class="p">,</span>
                       <span class="ss">:url</span> <span class="o">=&gt;</span> <span class="n">entry</span><span class="o">.</span><span class="n">url</span><span class="p">,</span>
                       <span class="ss">:feed</span> <span class="o">=&gt;</span> <span class="nb">self</span><span class="p">,</span>
                       <span class="ss">:updated_at</span> <span class="o">=&gt;</span> <span class="n">entry</span><span class="o">.</span><span class="n">updated</span><span class="p">)</span>
      <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-11'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-11">&#182;</a>
        </div>
        <p>Strip HTML</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">u</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="no">Nokogiri</span><span class="o">::</span><span class="no">HTML</span><span class="o">::</span><span class="no">Document</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">content</span><span class="p">)</span><span class="o">.</span><span class="n">text</span></pre></div>
      </td>
    </tr>
    <tr id='section-12'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-12">&#182;</a>
        </div>
        <p>Truncate text</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">truncation_necessary</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">140</span>
      <span class="k">if</span> <span class="n">truncation_necessary</span>
        <span class="n">u</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">text</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">138</span><span class="o">]</span>
      <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-13'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-13">&#182;</a>
        </div>
        <p>Generate HTML</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">if</span> <span class="n">truncation_necessary</span>
        <span class="n">u</span><span class="o">.</span><span class="n">html</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">u</span><span class="o">.</span><span class="n">to_html</span><span class="si">}</span><span class="s2">&lt;a href=&#39;</span><span class="si">#{</span><span class="n">entry</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="s2">&#39;&gt;\u2026&lt;/a&gt;&quot;</span>
      <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-14'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-14">&#182;</a>
        </div>
        <p>Commit</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">u</span><span class="o">.</span><span class="n">save</span>

      <span class="k">if</span> <span class="n">new_update</span>
        <span class="nb">self</span><span class="o">.</span><span class="n">updates</span> <span class="o">&lt;&lt;</span> <span class="n">u</span>
      <span class="k">end</span>

    <span class="k">end</span>

    <span class="n">save</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-15'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-15">&#182;</a>
        </div>
        <p>Pings hub
needs absolute url for feed to give to hub for callback</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nf">ping_hubs</span>
    <span class="n">feed_url</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">url</span><span class="si">}</span><span class="s2">.atom&quot;</span>
    <span class="no">OPub</span><span class="o">::</span><span class="no">Publisher</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">feed_url</span><span class="p">,</span> <span class="n">hubs</span><span class="p">)</span><span class="o">.</span><span class="n">ping_hubs</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">local?</span>
    <span class="n">remote_url</span><span class="o">.</span><span class="n">nil?</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">url</span><span class="p">(</span><span class="n">atom_format</span> <span class="o">=</span> <span class="kp">false</span><span class="p">)</span>
    <span class="n">url</span> <span class="o">=</span> <span class="p">(</span><span class="n">remote_url</span><span class="o">.</span><span class="n">nil?</span> <span class="o">&amp;&amp;</span> <span class="n">author</span><span class="p">)</span> <span class="p">?</span> <span class="s2">&quot;http://</span><span class="si">#{</span><span class="n">author</span><span class="o">.</span><span class="n">domain</span><span class="si">}</span><span class="s2">/feeds/</span><span class="si">#{</span><span class="nb">id</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">:</span> <span class="n">remote_url</span>
    <span class="n">url</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;.atom&quot;</span> <span class="k">if</span> <span class="n">atom_format</span>
    <span class="n">url</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">update_entries</span><span class="p">(</span><span class="n">atom_xml</span><span class="p">,</span> <span class="n">callback_url</span><span class="p">,</span> <span class="n">feed_url</span><span class="p">,</span> <span class="n">signature</span><span class="p">)</span>
    <span class="nb">sub</span> <span class="o">=</span> <span class="no">OSub</span><span class="o">::</span><span class="no">Subscription</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">callback_url</span><span class="p">,</span> <span class="n">feed_url</span><span class="p">,</span> <span class="nb">self</span><span class="o">.</span><span class="n">secret</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">sub</span><span class="o">.</span><span class="n">verify_content</span><span class="p">(</span><span class="n">atom_xml</span><span class="p">,</span> <span class="n">signature</span><span class="p">)</span>
      <span class="n">os_feed</span> <span class="o">=</span> <span class="no">OStatus</span><span class="o">::</span><span class="no">Feed</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="n">atom_xml</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-16'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-16">&#182;</a>
        </div>
        <p>XXX: Update author if necessary</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">populate_entries</span><span class="p">(</span><span class="n">os_feed</span><span class="o">.</span><span class="n">entries</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">default_hubs</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">hubs</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;http://rstatus.superfeedr.com/&quot;</span>

    <span class="n">save</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-17'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-17">&#182;</a>
        </div>
        <p>create atom feed
need base_uri since urls outgoing should be absolute</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nf">atom</span><span class="p">(</span><span class="n">base_uri</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-18'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-18">&#182;</a>
        </div>
        <p>Create the OStatus::Author object</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">os_auth</span> <span class="o">=</span> <span class="n">author</span><span class="o">.</span><span class="n">to_atom</span></pre></div>
      </td>
    </tr>
    <tr id='section-19'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-19">&#182;</a>
        </div>
        <p>Gather entries as OStatus::Entry objects</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">entries</span> <span class="o">=</span> <span class="n">updates</span><span class="o">.</span><span class="n">to_a</span><span class="o">.</span><span class="n">sort</span><span class="p">{</span><span class="o">|</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="o">|</span> <span class="n">b</span><span class="o">.</span><span class="n">created_at</span> <span class="o">&lt;=&gt;</span> <span class="n">a</span><span class="o">.</span><span class="n">created_at</span><span class="p">}</span><span class="o">.</span><span class="n">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">update</span><span class="o">|</span>
      <span class="n">update</span><span class="o">.</span><span class="n">to_atom</span><span class="p">(</span><span class="n">base_uri</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">avatar_url_abs</span> <span class="o">=</span> <span class="n">author</span><span class="o">.</span><span class="n">avatar_url</span>
    <span class="k">if</span> <span class="n">avatar_url_abs</span><span class="o">.</span><span class="n">start_with?</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
      <span class="n">avatar_url_abs</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">base_uri</span><span class="si">}#{</span><span class="n">author</span><span class="o">.</span><span class="n">avatar_url</span><span class="o">[</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="o">-</span><span class="mi">1</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-20'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-20">&#182;</a>
        </div>
        <p>Create a Feed representation which we can generate
the Atom feed and send out.</p>

      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">feed</span> <span class="o">=</span> <span class="no">OStatus</span><span class="o">::</span><span class="no">Feed</span><span class="o">.</span><span class="n">from_data</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">base_uri</span><span class="si">}</span><span class="s2">feeds/</span><span class="si">#{</span><span class="nb">id</span><span class="si">}</span><span class="s2">.atom&quot;</span><span class="p">,</span>
                             <span class="ss">:title</span> <span class="o">=&gt;</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">author</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2">&#39;s Updates&quot;</span><span class="p">,</span>
                             <span class="ss">:logo</span> <span class="o">=&gt;</span> <span class="n">avatar_url_abs</span><span class="p">,</span>
                             <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">base_uri</span><span class="si">}</span><span class="s2">feeds/</span><span class="si">#{</span><span class="nb">id</span><span class="si">}</span><span class="s2">.atom&quot;</span><span class="p">,</span>
                             <span class="ss">:author</span> <span class="o">=&gt;</span> <span class="n">os_auth</span><span class="p">,</span>
                             <span class="ss">:updated</span> <span class="o">=&gt;</span> <span class="n">updated_at</span><span class="p">,</span>
                             <span class="ss">:entries</span> <span class="o">=&gt;</span> <span class="n">entries</span><span class="p">,</span>
                             <span class="ss">:links</span> <span class="o">=&gt;</span> <span class="p">{</span>
                               <span class="ss">:hub</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="p">{</span><span class="ss">:href</span> <span class="o">=&gt;</span> <span class="n">hubs</span><span class="o">.</span><span class="n">first</span><span class="p">}</span><span class="o">]</span><span class="p">,</span>
                               <span class="ss">:salmon</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="p">{</span><span class="ss">:href</span> <span class="o">=&gt;</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">base_uri</span><span class="si">}</span><span class="s2">feeds/</span><span class="si">#{</span><span class="nb">id</span><span class="si">}</span><span class="s2">/salmon&quot;</span><span class="p">}</span><span class="o">]</span><span class="p">,</span>
                               <span class="ss">:&quot;http://salmon-protocol.org/ns/salmon-replies&quot;</span> <span class="o">=&gt;</span>
                                 <span class="o">[</span><span class="p">{</span><span class="ss">:href</span> <span class="o">=&gt;</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">base_uri</span><span class="si">}</span><span class="s2">feeds/</span><span class="si">#{</span><span class="nb">id</span><span class="si">}</span><span class="s2">/salmon&quot;</span><span class="p">}</span><span class="o">]</span><span class="p">,</span>
                               <span class="ss">:&quot;http://salmon-protocol.org/ns/salmon-mention&quot;</span> <span class="o">=&gt;</span>
                                 <span class="o">[</span><span class="p">{</span><span class="ss">:href</span> <span class="o">=&gt;</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">base_uri</span><span class="si">}</span><span class="s2">feeds/</span><span class="si">#{</span><span class="nb">id</span><span class="si">}</span><span class="s2">/salmon&quot;</span><span class="p">}</span><span class="o">]</span>
                             <span class="p">})</span>
    <span class="n">feed</span><span class="o">.</span><span class="n">atom</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">last_update</span>
    <span class="no">Update</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:feed_id</span> <span class="o">=&gt;</span> <span class="nb">id</span><span class="p">)</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="o">[</span><span class="s1">&#39;created_at&#39;</span><span class="p">,</span> <span class="s1">&#39;descending&#39;</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
