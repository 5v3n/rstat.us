<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>update.rb</title>
  <link rel="stylesheet" href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div id="jump_to">
    Jump To &hellip;
    <div id="jump_wrapper">
      <div id="jump_page">
          <a class="source" href="../controllers/application_controller.html">application_controller.rb</a>
          <a class="source" href="../controllers/auth_controller.html">auth_controller.rb</a>
          <a class="source" href="../controllers/feeds_controller.html">feeds_controller.rb</a>
          <a class="source" href="../controllers/salmon_controller.html">salmon_controller.rb</a>
          <a class="source" href="../controllers/searches_controller.html">searches_controller.rb</a>
          <a class="source" href="../controllers/sessions_controller.html">sessions_controller.rb</a>
          <a class="source" href="../controllers/static_controller.html">static_controller.rb</a>
          <a class="source" href="../controllers/subscriptions_controller.html">subscriptions_controller.rb</a>
          <a class="source" href="../controllers/updates_controller.html">updates_controller.rb</a>
          <a class="source" href="../controllers/users_controller.html">users_controller.rb</a>
          <a class="source" href="../controllers/webfinger_controller.html">webfinger_controller.rb</a>
          <a class="source" href="../decorators/application_decorator.html">application_decorator.rb</a>
          <a class="source" href="../decorators/author_decorator.html">author_decorator.rb</a>
          <a class="source" href="../decorators/user_decorator.html">user_decorator.rb</a>
          <a class="source" href="author.html">author.rb</a>
          <a class="source" href="authorization.html">authorization.rb</a>
          <a class="source" href="feed.html">feed.rb</a>
          <a class="source" href="notifier.html">notifier.rb</a>
          <a class="source" href="update.html">update.rb</a>
          <a class="source" href="user.html">user.rb</a>
          <a class="source" href="webfinger.html">webfinger.rb</a>
      </div>
    </div>
  </div>
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>update.rb</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-1'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-1">&#182;</a>
        </div>
        <p>An Update is a particular status message sent by one of our users.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="k">class</span> <span class="nc">Update</span>
  <span class="nb">require</span> <span class="s1">&#39;cgi&#39;</span>
  <span class="kp">include</span> <span class="no">MongoMapper</span><span class="o">::</span><span class="no">Document</span></pre></div>
      </td>
    </tr>
    <tr id='section-2'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-2">&#182;</a>
        </div>
        <p>Determines what constitutes a username inside an update text</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="no">USERNAME_REGULAR_EXPRESSION</span> <span class="o">=</span> <span class="sr">/(^|[ \t\n\r\f&quot;&#39;\(\[{]+)@([^ \t\n\r\f&amp;?=@%\/\#]*[^ \t\n\r\f&amp;?=@%\/\#.!:;,&quot;&#39;\]}\)])(?:@([^ \t\n\r\f&amp;?=@%\/\#]*[^ \t\n\r\f&amp;?=@%\/\#.!:;,&quot;&#39;\]}\)]))?/</span></pre></div>
      </td>
    </tr>
    <tr id='section-3'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-3">&#182;</a>
        </div>
        <p>Updates are aggregated in Feeds</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">belongs_to</span> <span class="ss">:feed</span>
  <span class="n">key</span> <span class="ss">:feed_id</span><span class="p">,</span> <span class="no">ObjectId</span></pre></div>
      </td>
    </tr>
    <tr id='section-4'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-4">&#182;</a>
        </div>
        <p>Updates are written by Authors</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">belongs_to</span> <span class="ss">:author</span>
  <span class="n">key</span> <span class="ss">:author_id</span><span class="p">,</span> <span class="no">ObjectId</span>
  <span class="n">validates_presence_of</span> <span class="ss">:author_id</span></pre></div>
      </td>
    </tr>
    <tr id='section-5'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-5">&#182;</a>
        </div>
        <p>The content of the update, unaltered, is stored here</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">key</span> <span class="ss">:text</span><span class="p">,</span> <span class="nb">String</span><span class="p">,</span> <span class="ss">:default</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span>
  <span class="n">validates_length_of</span> <span class="ss">:text</span><span class="p">,</span> <span class="ss">:minimum</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="ss">:maximum</span> <span class="o">=&gt;</span> <span class="mi">140</span>
  <span class="n">validate</span> <span class="ss">:do_not_repeat_yourself</span><span class="p">,</span> <span class="ss">:on</span> <span class="o">=&gt;</span> <span class="ss">:create</span></pre></div>
      </td>
    </tr>
    <tr id='section-6'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-6">&#182;</a>
        </div>
        <p>Mentions are stored in the following array</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">key</span> <span class="ss">:mention_ids</span><span class="p">,</span> <span class="nb">Array</span>
  <span class="n">many</span> <span class="ss">:mentions</span><span class="p">,</span> <span class="ss">:in</span> <span class="o">=&gt;</span> <span class="ss">:mention_ids</span><span class="p">,</span> <span class="ss">:class_name</span> <span class="o">=&gt;</span> <span class="s1">&#39;Author&#39;</span>
  <span class="n">before_save</span> <span class="ss">:get_mentions</span></pre></div>
      </td>
    </tr>
    <tr id='section-7'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-7">&#182;</a>
        </div>
        <p>The following are extra features and identifications for the update</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">key</span> <span class="ss">:tags</span><span class="p">,</span> <span class="nb">Array</span><span class="p">,</span> <span class="ss">:default</span> <span class="o">=&gt;</span> <span class="o">[]</span>
  <span class="n">key</span> <span class="ss">:twitter</span><span class="p">,</span> <span class="no">Boolean</span></pre></div>
      </td>
    </tr>
    <tr id='section-8'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-8">&#182;</a>
        </div>
        <p>For speed, we generate the html for the update lazily when it is rendered</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">key</span> <span class="ss">:html</span><span class="p">,</span> <span class="nb">String</span></pre></div>
      </td>
    </tr>
    <tr id='section-9'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-9">&#182;</a>
        </div>
        <p>We also generate the tags upon editing the update</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">before_save</span> <span class="ss">:get_tags</span></pre></div>
      </td>
    </tr>
    <tr id='section-10'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-10">&#182;</a>
        </div>
        <p>Updates have a remote url that globally identifies them</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">key</span> <span class="ss">:remote_url</span><span class="p">,</span> <span class="nb">String</span></pre></div>
      </td>
    </tr>
    <tr id='section-11'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-11">&#182;</a>
        </div>
        <p>Reply and restate identifiers
Local Update id: (nil if remote)</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">key</span> <span class="ss">:referral_id</span></pre></div>
      </td>
    </tr>
    <tr id='section-12'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-12">&#182;</a>
        </div>
        <p>Remote Update url: (nil if local)</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">key</span> <span class="ss">:referral_url</span><span class="p">,</span> <span class="nb">String</span>

  <span class="k">def</span> <span class="nf">referral</span>
    <span class="no">Update</span><span class="o">.</span><span class="n">first</span><span class="p">(</span><span class="ss">:id</span> <span class="o">=&gt;</span> <span class="n">referral_id</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">url</span>
    <span class="n">feed</span><span class="o">.</span><span class="n">local?</span> <span class="p">?</span> <span class="s2">&quot;/updates/</span><span class="si">#{</span><span class="nb">id</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">:</span> <span class="n">remote_url</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">url</span><span class="o">=</span><span class="p">(</span><span class="n">the_url</span><span class="p">)</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">remote_url</span> <span class="o">=</span> <span class="n">the_url</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">to_html</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">html</span> <span class="o">||</span> <span class="n">generate_html</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">mentioned?</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
    <span class="n">matches</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sr">/@</span><span class="si">#{</span><span class="n">username</span><span class="si">}</span><span class="sr">\b/</span><span class="p">)</span>
    <span class="n">matches</span><span class="o">.</span><span class="n">nil?</span> <span class="p">?</span> <span class="kp">false</span> <span class="p">:</span> <span class="n">matches</span><span class="o">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-13'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-13">&#182;</a>
        </div>
        <p>These handle sending the update to other nodes and services</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">after_create</span> <span class="ss">:send_to_remote_mentions</span>
  <span class="n">after_create</span> <span class="ss">:send_to_external_accounts</span>

  <span class="n">timestamps!</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">hot_updates</span>
    <span class="n">all</span><span class="p">(</span><span class="ss">:limit</span> <span class="o">=&gt;</span> <span class="mi">6</span><span class="p">,</span> <span class="ss">:order</span> <span class="o">=&gt;</span> <span class="s1">&#39;created_at desc&#39;</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">get_tags</span>
    <span class="nb">self</span><span class="o">[</span><span class="ss">:tags</span><span class="o">]</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="sr">/#([\w\-\.]*)/</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-14'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-14">&#182;</a>
        </div>
        <p>Return OStatus::Entry instance describing this Update</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nf">to_atom</span><span class="p">(</span><span class="n">base_uri</span><span class="p">)</span>
    <span class="n">links</span> <span class="o">=</span> <span class="o">[]</span>
    <span class="n">links</span> <span class="o">&lt;&lt;</span> <span class="no">Atom</span><span class="o">::</span><span class="no">Link</span><span class="o">.</span><span class="n">new</span><span class="p">({</span> <span class="ss">:href</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">base_uri</span><span class="si">}</span><span class="s2">updates/</span><span class="si">#{</span><span class="nb">self</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">to_s</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)})</span>

    <span class="n">mentions</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">author</span><span class="o">|</span>
      <span class="n">author_url</span> <span class="o">=</span> <span class="n">author</span><span class="o">.</span><span class="n">url</span>
      <span class="k">if</span> <span class="n">author_url</span><span class="o">.</span><span class="n">start_with?</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="n">author_url</span> <span class="o">=</span> <span class="s2">&quot;http://</span><span class="si">#{</span><span class="n">author</span><span class="o">.</span><span class="n">domain</span><span class="si">}</span><span class="s2">/feeds/</span><span class="si">#{</span><span class="n">author</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span>
      <span class="k">end</span>

      <span class="n">links</span> <span class="o">&lt;&lt;</span> <span class="no">Atom</span><span class="o">::</span><span class="no">Link</span><span class="o">.</span><span class="n">new</span><span class="p">({</span> <span class="ss">:rel</span> <span class="o">=&gt;</span> <span class="s1">&#39;ostatus:attention&#39;</span><span class="p">,</span> <span class="ss">:href</span> <span class="o">=&gt;</span> <span class="n">author_url</span> <span class="p">})</span>
      <span class="n">links</span> <span class="o">&lt;&lt;</span> <span class="no">Atom</span><span class="o">::</span><span class="no">Link</span><span class="o">.</span><span class="n">new</span><span class="p">({</span> <span class="ss">:rel</span> <span class="o">=&gt;</span> <span class="s1">&#39;mentioned&#39;</span><span class="p">,</span> <span class="ss">:href</span> <span class="o">=&gt;</span> <span class="n">author_url</span> <span class="p">})</span>
    <span class="k">end</span>

    <span class="no">OStatus</span><span class="o">::</span><span class="no">Entry</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:title</span> <span class="o">=&gt;</span> <span class="nb">self</span><span class="o">.</span><span class="n">text</span><span class="p">,</span>
                       <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="no">Atom</span><span class="o">::</span><span class="no">Content</span><span class="o">::</span><span class="no">Html</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">to_html</span><span class="p">),</span>
                       <span class="ss">:updated</span> <span class="o">=&gt;</span> <span class="nb">self</span><span class="o">.</span><span class="n">updated_at</span><span class="p">,</span>
                       <span class="ss">:published</span> <span class="o">=&gt;</span> <span class="nb">self</span><span class="o">.</span><span class="n">created_at</span><span class="p">,</span>
                       <span class="ss">:activity</span> <span class="o">=&gt;</span> <span class="no">OStatus</span><span class="o">::</span><span class="no">Activity</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:object_type</span> <span class="o">=&gt;</span> <span class="ss">:note</span><span class="p">),</span>
                       <span class="ss">:author</span> <span class="o">=&gt;</span> <span class="nb">self</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">to_atom</span><span class="p">,</span>
                       <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">base_uri</span><span class="si">}</span><span class="s2">updates/</span><span class="si">#{</span><span class="nb">self</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">to_s</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                       <span class="ss">:links</span> <span class="o">=&gt;</span> <span class="n">links</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">to_xml</span><span class="p">(</span><span class="n">base_uri</span><span class="p">)</span>
    <span class="n">to_atom</span><span class="p">(</span><span class="n">base_uri</span><span class="p">)</span><span class="o">.</span><span class="n">to_xml</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">create_from_ostatus</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">feed</span><span class="p">)</span>
    <span class="n">u</span> <span class="o">=</span> <span class="kp">new</span><span class="p">(</span><span class="ss">:author</span>     <span class="o">=&gt;</span> <span class="n">feed</span><span class="o">.</span><span class="n">author</span><span class="p">,</span>
            <span class="ss">:created_at</span> <span class="o">=&gt;</span> <span class="n">entry</span><span class="o">.</span><span class="n">published</span><span class="p">,</span>
            <span class="ss">:remote_url</span> <span class="o">=&gt;</span> <span class="n">entry</span><span class="o">.</span><span class="n">url</span><span class="p">,</span>
            <span class="ss">:feed</span>       <span class="o">=&gt;</span> <span class="n">feed</span><span class="p">,</span>
            <span class="ss">:updated_at</span> <span class="o">=&gt;</span> <span class="n">entry</span><span class="o">.</span><span class="n">updated</span><span class="p">)</span>

    <span class="n">u</span><span class="o">.</span><span class="n">sanitize_external_text</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
    <span class="n">u</span><span class="o">.</span><span class="n">save</span>
    <span class="n">u</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">sanitize_external_text</span><span class="p">(</span><span class="n">entry_text</span><span class="p">,</span> <span class="n">entry_url</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-15'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-15">&#182;</a>
        </div>
        <p>Strip HTML</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nb">self</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="no">Nokogiri</span><span class="o">::</span><span class="no">HTML</span><span class="o">::</span><span class="no">Document</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">entry_text</span><span class="p">)</span><span class="o">.</span><span class="n">text</span></pre></div>
      </td>
    </tr>
    <tr id='section-16'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-16">&#182;</a>
        </div>
        <p>Truncate text</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">truncation_necessary</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">140</span>
    <span class="k">if</span> <span class="n">truncation_necessary</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">text</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">138</span><span class="o">]</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-17'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-17">&#182;</a>
        </div>
        <p>Generate HTML</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">if</span> <span class="n">truncation_necessary</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">html</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="nb">self</span><span class="o">.</span><span class="n">to_html</span><span class="si">}</span><span class="s2">&lt;a href=&#39;</span><span class="si">#{</span><span class="n">entry_url</span><span class="si">}</span><span class="s2">&#39;&gt;\u2026&lt;/a&gt;&quot;</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">protected</span>

  <span class="k">def</span> <span class="nf">get_mentions</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">mentions</span> <span class="o">=</span> <span class="o">[]</span>

    <span class="n">out</span> <span class="o">=</span> <span class="no">CGI</span><span class="o">.</span><span class="n">escapeHTML</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

    <span class="n">out</span><span class="o">.</span><span class="n">gsub!</span><span class="p">(</span><span class="no">USERNAME_REGULAR_EXPRESSION</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">match</span><span class="o">|</span>
      <span class="k">if</span> <span class="vg">$3</span> <span class="ow">and</span> <span class="n">a</span> <span class="o">=</span> <span class="no">Author</span><span class="o">.</span><span class="n">first</span><span class="p">(</span><span class="ss">:username</span> <span class="o">=&gt;</span> <span class="sr">/^</span><span class="si">#{</span><span class="vg">$2</span><span class="si">}</span><span class="sr">$/i</span><span class="p">,</span> <span class="ss">:domain</span> <span class="o">=&gt;</span> <span class="sr">/^</span><span class="si">#{</span><span class="vg">$3</span><span class="si">}</span><span class="sr">$/i</span><span class="p">)</span>
        <span class="nb">self</span><span class="o">.</span><span class="n">mentions</span> <span class="o">&lt;&lt;</span> <span class="n">a</span>
      <span class="k">elsif</span> <span class="ow">not</span> <span class="vg">$3</span> <span class="ow">and</span> <span class="n">authors</span> <span class="o">=</span> <span class="no">Author</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="ss">:username</span> <span class="o">=&gt;</span> <span class="sr">/^</span><span class="si">#{</span><span class="vg">$2</span><span class="si">}</span><span class="sr">$/i</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="kp">nil</span>

        <span class="k">if</span> <span class="n">authors</span><span class="o">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">1</span>
          <span class="n">a</span> <span class="o">=</span> <span class="n">authors</span><span class="o">.</span><span class="n">first</span>
        <span class="k">else</span></pre></div>
      </td>
    </tr>
    <tr id='section-18'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-18">&#182;</a>
        </div>
        <p>Disambiguate</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-19'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-19">&#182;</a>
        </div>
        <p>Is it in update to this author?</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>          <span class="k">if</span> <span class="n">in_reply_to</span> <span class="o">=</span> <span class="n">referral</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">authors</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">in_reply_to</span><span class="o">.</span><span class="n">author</span><span class="p">)</span><span class="o">.</span><span class="n">nil?</span>
              <span class="n">a</span> <span class="o">=</span> <span class="n">in_reply_to</span><span class="o">.</span><span class="n">author</span>
            <span class="k">end</span>
          <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-20'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-20">&#182;</a>
        </div>
        <p>Is this update is generated by a local user,
look at who they are following</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>          <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">nil?</span> <span class="ow">and</span> <span class="n">user</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">user</span>
            <span class="n">authors</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">author</span><span class="o">|</span>
              <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">following_author?</span><span class="p">(</span><span class="n">author</span><span class="p">)</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">author</span>
              <span class="k">end</span>
            <span class="k">end</span>
          <span class="k">end</span>
        <span class="k">end</span>

        <span class="nb">self</span><span class="o">.</span><span class="n">mentions</span> <span class="o">&lt;&lt;</span> <span class="n">a</span> <span class="k">unless</span> <span class="n">a</span><span class="o">.</span><span class="n">nil?</span>
      <span class="k">end</span>
      <span class="n">match</span>
    <span class="k">end</span>

    <span class="nb">self</span><span class="o">.</span><span class="n">mentions</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-21'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-21">&#182;</a>
        </div>
        <p>Generate and store the html</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nf">generate_html</span>
    <span class="n">out</span> <span class="o">=</span> <span class="no">CGI</span><span class="o">.</span><span class="n">escapeHTML</span><span class="p">(</span><span class="n">text</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-22'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-22">&#182;</a>
        </div>
        <p>Replace any absolute addresses with a link
Note: Do this first! Otherwise it will add anchors inside anchors!</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">out</span><span class="o">.</span><span class="n">gsub!</span><span class="p">(</span><span class="sr">/(http[s]?:\/\/\S+[a-zA-Z0-9\/}])/</span><span class="p">,</span> <span class="s2">&quot;&lt;a href=&#39;</span><span class="se">\\</span><span class="s2">1&#39;&gt;</span><span class="se">\\</span><span class="s2">1&lt;/a&gt;&quot;</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-23'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-23">&#182;</a>
        </div>
        <p>we let almost anything be in a username, except those that mess with urls.
but you can&rsquo;t end in a .:;, or !
also ignore container chars [] () &ldquo;&rdquo; &lsquo;&rsquo; {}
XXX: the <em>correct</em> solution will be to use an email validator</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">out</span><span class="o">.</span><span class="n">gsub!</span><span class="p">(</span><span class="no">USERNAME_REGULAR_EXPRESSION</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">match</span><span class="o">|</span>
      <span class="k">if</span> <span class="vg">$3</span> <span class="ow">and</span> <span class="n">a</span> <span class="o">=</span> <span class="no">Author</span><span class="o">.</span><span class="n">first</span><span class="p">(</span><span class="ss">:username</span> <span class="o">=&gt;</span> <span class="sr">/^</span><span class="si">#{</span><span class="vg">$2</span><span class="si">}</span><span class="sr">$/i</span><span class="p">,</span> <span class="ss">:domain</span> <span class="o">=&gt;</span> <span class="sr">/^</span><span class="si">#{</span><span class="vg">$3</span><span class="si">}</span><span class="sr">$/i</span><span class="p">)</span>
        <span class="n">author_url</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">url</span>
        <span class="k">if</span> <span class="n">author_url</span><span class="o">.</span><span class="n">start_with?</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
          <span class="n">author_url</span> <span class="o">=</span> <span class="s2">&quot;http://</span><span class="si">#{</span><span class="n">author</span><span class="o">.</span><span class="n">domain</span><span class="si">}#{</span><span class="n">author_url</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">end</span>
        <span class="s2">&quot;</span><span class="si">#{</span><span class="vg">$1</span><span class="si">}</span><span class="s2">&lt;a href=&#39;</span><span class="si">#{</span><span class="n">author_url</span><span class="si">}</span><span class="s2">&#39;&gt;@</span><span class="si">#{</span><span class="vg">$2</span><span class="si">}</span><span class="s2">@</span><span class="si">#{</span><span class="vg">$3</span><span class="si">}</span><span class="s2">&lt;/a&gt;&quot;</span>
      <span class="k">elsif</span> <span class="ow">not</span> <span class="vg">$3</span> <span class="ow">and</span> <span class="n">a</span> <span class="o">=</span> <span class="no">Author</span><span class="o">.</span><span class="n">first</span><span class="p">(</span><span class="ss">:username</span> <span class="o">=&gt;</span> <span class="sr">/^</span><span class="si">#{</span><span class="vg">$2</span><span class="si">}</span><span class="sr">$/i</span><span class="p">)</span>
        <span class="n">author_url</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">url</span>
        <span class="k">if</span> <span class="n">author_url</span><span class="o">.</span><span class="n">start_with?</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
          <span class="n">author_url</span> <span class="o">=</span> <span class="s2">&quot;http://</span><span class="si">#{</span><span class="n">author</span><span class="o">.</span><span class="n">domain</span><span class="si">}#{</span><span class="n">author_url</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">end</span>
        <span class="s2">&quot;</span><span class="si">#{</span><span class="vg">$1</span><span class="si">}</span><span class="s2">&lt;a href=&#39;</span><span class="si">#{</span><span class="n">author_url</span><span class="si">}</span><span class="s2">&#39;&gt;@</span><span class="si">#{</span><span class="vg">$2</span><span class="si">}</span><span class="s2">&lt;/a&gt;&quot;</span>
      <span class="k">else</span>
        <span class="n">match</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">out</span><span class="o">.</span><span class="n">gsub!</span><span class="p">(</span><span class="sr">/(^|\s+)#(\w+)/</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">match</span><span class="o">|</span>
      <span class="s2">&quot;</span><span class="si">#{</span><span class="vg">$1</span><span class="si">}</span><span class="s2">&lt;a href=&#39;/search?q=%23</span><span class="si">#{</span><span class="vg">$2</span><span class="si">}</span><span class="s2">&#39;&gt;#</span><span class="si">#{</span><span class="vg">$2</span><span class="si">}</span><span class="s2">&lt;/a&gt;&quot;</span>
    <span class="k">end</span>

    <span class="nb">self</span><span class="o">.</span><span class="n">html</span> <span class="o">=</span> <span class="n">out</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">send_to_remote_mentions</span></pre></div>
      </td>
    </tr>
    <tr id='section-24'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-24">&#182;</a>
        </div>
        <p>Only local users can do this</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">if</span> <span class="n">author</span><span class="o">.</span><span class="n">user</span></pre></div>
      </td>
    </tr>
    <tr id='section-25'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-25">&#182;</a>
        </div>
        <p>For each mention, if they are not following this user, send
this update to them as a salmon notification
XXX: allow for authors that we do not know (who do not have feeds)</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">mentions</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">mentioned_author</span><span class="o">|</span>
        <span class="k">unless</span> <span class="n">mentioned_author</span><span class="o">.</span><span class="n">domain</span> <span class="o">==</span> <span class="n">author</span><span class="o">.</span><span class="n">domain</span>
          <span class="n">mentioned_feed</span> <span class="o">=</span> <span class="n">mentioned_author</span><span class="o">.</span><span class="n">feed</span>
          <span class="k">unless</span> <span class="n">author</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">followers</span><span class="o">.</span><span class="n">include?</span> <span class="n">mentioned_feed</span>
            <span class="n">author</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">delay</span><span class="o">.</span><span class="n">send_mention_notification</span> <span class="nb">id</span><span class="p">,</span> <span class="n">mentioned_feed</span><span class="o">.</span><span class="n">id</span>
          <span class="k">end</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-26'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-26">&#182;</a>
        </div>
        <p>If a user has twitter enabled on their account and they checked
it on update form, repost the update to twitter</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nf">send_to_external_accounts</span>
    <span class="k">return</span> <span class="k">if</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;RAILS_ENV&#39;</span><span class="o">]</span> <span class="o">==</span> <span class="s1">&#39;development&#39;</span></pre></div>
      </td>
    </tr>
    <tr id='section-27'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-27">&#182;</a>
        </div>
        <p>If there is no user we can&rsquo;t get to the oauth tokens, abort!</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">if</span> <span class="n">author</span><span class="o">.</span><span class="n">user</span></pre></div>
      </td>
    </tr>
    <tr id='section-28'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-28">&#182;</a>
        </div>
        <p>If the twitter flag is true and the user has a twitter account linked
send the update</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">if</span> <span class="nb">self</span><span class="o">.</span><span class="n">twitter?</span> <span class="o">&amp;&amp;</span> <span class="n">author</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">twitter?</span>
        <span class="k">begin</span>
          <span class="no">Twitter</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
            <span class="n">config</span><span class="o">.</span><span class="n">consumer_key</span> <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s2">&quot;CONSUMER_KEY&quot;</span><span class="o">]</span>
            <span class="n">config</span><span class="o">.</span><span class="n">consumer_secret</span> <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s2">&quot;CONSUMER_SECRET&quot;</span><span class="o">]</span>
            <span class="n">config</span><span class="o">.</span><span class="n">oauth_token</span> <span class="o">=</span> <span class="n">author</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">twitter</span><span class="o">.</span><span class="n">oauth_token</span>
            <span class="n">config</span><span class="o">.</span><span class="n">oauth_token_secret</span> <span class="o">=</span> <span class="n">author</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">twitter</span><span class="o">.</span><span class="n">oauth_secret</span>
          <span class="k">end</span>

          <span class="no">Twitter</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">rescue</span> <span class="no">Exception</span> <span class="o">=&gt;</span> <span class="n">e</span></pre></div>
      </td>
    </tr>
    <tr id='section-29'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-29">&#182;</a>
        </div>
        <p>I should be shot for doing this.</p>

      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>

  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">do_not_repeat_yourself</span>
    <span class="n">errors</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="ss">:text</span><span class="p">,</span> <span class="s2">&quot;You already posted this update.&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">already_posted?</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">already_posted?</span>
    <span class="n">feed</span><span class="o">.</span><span class="n">last_update</span> <span class="o">&amp;&amp;</span> <span class="n">feed</span><span class="o">.</span><span class="n">last_update</span><span class="o">.</span><span class="n">id</span> <span class="o">!=</span> <span class="nb">id</span> <span class="o">&amp;&amp;</span> <span class="n">feed</span><span class="o">.</span><span class="n">last_update</span><span class="o">.</span><span class="n">text</span> <span class="o">==</span> <span class="n">text</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
