<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>auth_controller.rb</title>
  <link rel="stylesheet" href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div id="jump_to">
    Jump To &hellip;
    <div id="jump_wrapper">
      <div id="jump_page">
          <a class="source" href="application_controller.html">application_controller.rb</a>
          <a class="source" href="auth_controller.html">auth_controller.rb</a>
          <a class="source" href="feeds_controller.html">feeds_controller.rb</a>
          <a class="source" href="salmon_controller.html">salmon_controller.rb</a>
          <a class="source" href="searches_controller.html">searches_controller.rb</a>
          <a class="source" href="sessions_controller.html">sessions_controller.rb</a>
          <a class="source" href="static_controller.html">static_controller.rb</a>
          <a class="source" href="subscriptions_controller.html">subscriptions_controller.rb</a>
          <a class="source" href="updates_controller.html">updates_controller.rb</a>
          <a class="source" href="users_controller.html">users_controller.rb</a>
          <a class="source" href="webfinger_controller.html">webfinger_controller.rb</a>
          <a class="source" href="../decorators/application_decorator.html">application_decorator.rb</a>
          <a class="source" href="../decorators/author_decorator.html">author_decorator.rb</a>
          <a class="source" href="../decorators/user_decorator.html">user_decorator.rb</a>
          <a class="source" href="../models/author.html">author.rb</a>
          <a class="source" href="../models/authorization.html">authorization.rb</a>
          <a class="source" href="../models/feed.html">feed.rb</a>
          <a class="source" href="../models/notifier.html">notifier.rb</a>
          <a class="source" href="../models/update.html">update.rb</a>
          <a class="source" href="../models/user.html">user.rb</a>
          <a class="source" href="../models/webfinger.html">webfinger.rb</a>
      </div>
    </div>
  </div>
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>auth_controller.rb</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-1'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-1">&#182;</a>
        </div>
        <p>This controller handles all of the external authentication needs of Rstatus.
We&rsquo;re using OmniAuth to handle our Twitter connections, so these
routes are all derived from that codebase.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="k">class</span> <span class="nc">AuthController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span></pre></div>
      </td>
    </tr>
    <tr id='section-2'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-2">&#182;</a>
        </div>
        <p>Omniauth callback after a successful oauth session has been established.
New users and existing users adding linked accounts both use this callback
to obtain oauth credentials.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nf">auth</span>
    <span class="n">auth</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">env</span><span class="o">[</span><span class="s1">&#39;omniauth.auth&#39;</span><span class="o">]</span></pre></div>
      </td>
    </tr>
    <tr id='section-3'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-3">&#182;</a>
        </div>
        <p>If an authorization is not present then that request is assumed to be for
a new account. If a request comes from a user that is logged in, it is
assumed to originate from the edit profile page and the request is to add
a linked account. If the request does not come from a user it is assumed
to be a new user and the auth information is collected to provision a new
account.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">unless</span> <span class="vi">@auth</span> <span class="o">=</span> <span class="no">Authorization</span><span class="o">.</span><span class="n">find_from_hash</span><span class="p">(</span><span class="n">auth</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">logged_in?</span>
        <span class="no">Authorization</span><span class="o">.</span><span class="n">create_from_hash!</span><span class="p">(</span><span class="n">auth</span><span class="p">,</span> <span class="n">root_url</span><span class="p">,</span> <span class="n">current_user</span><span class="p">)</span>
        <span class="n">redirect_to</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span>
        <span class="k">return</span>
      <span class="k">else</span></pre></div>
      </td>
    </tr>
    <tr id='section-4'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-4">&#182;</a>
        </div>
        <p>This situation here really sucks. I&rsquo;d like to do something better,
and maybe the correct answer is just session[:auth] = auth. This
might be a nice refactoring.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="n">session</span><span class="o">[</span><span class="ss">:uid</span><span class="o">]</span> <span class="o">=</span> <span class="n">auth</span><span class="o">[</span><span class="s1">&#39;uid&#39;</span><span class="o">]</span>
        <span class="n">session</span><span class="o">[</span><span class="ss">:provider</span><span class="o">]</span> <span class="o">=</span> <span class="n">auth</span><span class="o">[</span><span class="s1">&#39;provider&#39;</span><span class="o">]</span>
        <span class="n">session</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span> <span class="o">=</span> <span class="n">auth</span><span class="o">[</span><span class="s1">&#39;user_info&#39;</span><span class="o">][</span><span class="s1">&#39;name&#39;</span><span class="o">]</span>
        <span class="n">session</span><span class="o">[</span><span class="ss">:nickname</span><span class="o">]</span> <span class="o">=</span> <span class="n">auth</span><span class="o">[</span><span class="s1">&#39;user_info&#39;</span><span class="o">][</span><span class="s1">&#39;nickname&#39;</span><span class="o">]</span>
        <span class="n">session</span><span class="o">[</span><span class="ss">:website</span><span class="o">]</span> <span class="o">=</span> <span class="n">auth</span><span class="o">[</span><span class="s1">&#39;user_info&#39;</span><span class="o">][</span><span class="s1">&#39;urls&#39;</span><span class="o">][</span><span class="s1">&#39;Website&#39;</span><span class="o">]</span>
        <span class="n">session</span><span class="o">[</span><span class="ss">:description</span><span class="o">]</span> <span class="o">=</span> <span class="n">auth</span><span class="o">[</span><span class="s1">&#39;user_info&#39;</span><span class="o">][</span><span class="s1">&#39;description&#39;</span><span class="o">]</span>
        <span class="n">session</span><span class="o">[</span><span class="ss">:image</span><span class="o">]</span> <span class="o">=</span> <span class="n">auth</span><span class="o">[</span><span class="s1">&#39;user_info&#39;</span><span class="o">][</span><span class="s1">&#39;image&#39;</span><span class="o">]</span>
        <span class="n">session</span><span class="o">[</span><span class="ss">:email</span><span class="o">]</span> <span class="o">=</span> <span class="n">auth</span><span class="o">[</span><span class="s1">&#39;user_info&#39;</span><span class="o">][</span><span class="s1">&#39;email&#39;</span><span class="o">]</span>
        <span class="n">session</span><span class="o">[</span><span class="ss">:oauth_token</span><span class="o">]</span> <span class="o">=</span> <span class="n">auth</span><span class="o">[</span><span class="s1">&#39;credentials&#39;</span><span class="o">][</span><span class="s1">&#39;token&#39;</span><span class="o">]</span>
        <span class="n">session</span><span class="o">[</span><span class="ss">:oauth_secret</span><span class="o">]</span> <span class="o">=</span> <span class="n">auth</span><span class="o">[</span><span class="s1">&#39;credentials&#39;</span><span class="o">][</span><span class="s1">&#39;secret&#39;</span><span class="o">]</span></pre></div>
      </td>
    </tr>
    <tr id='section-5'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-5">&#182;</a>
        </div>
        <p>The username is checked to ensure it is unique, if it is not,
the user is informed that they need to change it.
Everyone is redirected to /users/new to confirm that they&rsquo;d like
to have their username.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="k">if</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span> <span class="ss">:username</span> <span class="o">=&gt;</span> <span class="n">auth</span><span class="o">[</span><span class="s1">&#39;user_info&#39;</span><span class="o">][</span><span class="s1">&#39;nickname&#39;</span><span class="o">]</span>
          <span class="n">flash</span><span class="o">[</span><span class="ss">:error</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Sorry, someone else has that username. Please pick another.&quot;</span>
        <span class="k">end</span>

        <span class="n">redirect_to</span> <span class="n">new_user_path</span>
        <span class="k">return</span>
      <span class="k">end</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-6'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-6">&#182;</a>
        </div>
        <p>If an authorization is present then it is assumed to be a successful
authentication. The oauth credentials for the user in question are checked
and updated.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="vi">@auth</span><span class="o">.</span><span class="n">oauth_token</span> <span class="o">=</span> <span class="n">auth</span><span class="o">[</span><span class="s1">&#39;credentials&#39;</span><span class="o">][</span><span class="s1">&#39;token&#39;</span><span class="o">]</span>
    <span class="vi">@auth</span><span class="o">.</span><span class="n">oauth_secret</span> <span class="o">=</span> <span class="n">auth</span><span class="o">[</span><span class="s1">&#39;credentials&#39;</span><span class="o">][</span><span class="s1">&#39;secret&#39;</span><span class="o">]</span>
    <span class="vi">@auth</span><span class="o">.</span><span class="n">nickname</span> <span class="o">=</span> <span class="n">auth</span><span class="o">[</span><span class="s1">&#39;user_info&#39;</span><span class="o">][</span><span class="s1">&#39;nickname&#39;</span><span class="o">]</span>
    <span class="vi">@auth</span><span class="o">.</span><span class="n">save</span>

    <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="vi">@auth</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span>

    <span class="n">flash</span><span class="o">[</span><span class="ss">:notice</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;You&#39;re now logged in.&quot;</span>

    <span class="n">redirect_to</span> <span class="n">root_path</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">failure</span>
    <span class="k">if</span> <span class="n">params</span><span class="o">[</span><span class="ss">:message</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&quot;invalid_credentials&quot;</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:error</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;We were unable to use your credentials to log you in. &quot;</span> <span class="o">+</span>
                      <span class="s2">&quot;Try again?&quot;</span>
    <span class="k">elsif</span> <span class="n">params</span><span class="o">[</span><span class="ss">:message</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&quot;timeout&quot;</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:error</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;We were unable to use your credentials because of a timeout. &quot;</span> <span class="o">+</span>
                      <span class="s2">&quot;This is likely a temporary problem so feel free to try again.&quot;</span>
    <span class="k">else</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:error</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;We were unable to use your credentials because of a yet &quot;</span> <span class="o">+</span>
                      <span class="s2">&quot;undetermined problem. Hopefully this is temporary so &quot;</span> <span class="o">+</span>
                      <span class="s2">&quot;feel free to try again.&quot;</span>
    <span class="k">end</span>

    <span class="n">redirect_to</span> <span class="n">new_session_url</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-7'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-7">&#182;</a>
        </div>
        <p>This lets someone remove a particular Authorization from their account.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="p">(</span><span class="ss">:username</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:username</span><span class="o">]</span><span class="p">)</span>
      <span class="n">auth</span> <span class="o">=</span> <span class="no">Authorization</span><span class="o">.</span><span class="n">first</span><span class="p">(</span><span class="ss">:provider</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:provider</span><span class="o">]</span><span class="p">,</span> <span class="ss">:user_id</span> <span class="o">=&gt;</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
      <span class="n">auth</span><span class="o">.</span><span class="n">destroy</span> <span class="k">if</span> <span class="n">auth</span></pre></div>
      </td>
    </tr>
    <tr id='section-8'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-8">&#182;</a>
        </div>
        <p>Without re-setting the session[:user_id] we&rsquo;re logged out</p>

      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
    <span class="k">end</span>

    <span class="n">redirect_to</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
