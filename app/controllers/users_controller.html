<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>users_controller.rb</title>
  <link rel="stylesheet" href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div id="jump_to">
    Jump To &hellip;
    <div id="jump_wrapper">
      <div id="jump_page">
          <a class="source" href="application_controller.html">application_controller.rb</a>
          <a class="source" href="auth_controller.html">auth_controller.rb</a>
          <a class="source" href="feeds_controller.html">feeds_controller.rb</a>
          <a class="source" href="salmon_controller.html">salmon_controller.rb</a>
          <a class="source" href="searches_controller.html">searches_controller.rb</a>
          <a class="source" href="sessions_controller.html">sessions_controller.rb</a>
          <a class="source" href="static_controller.html">static_controller.rb</a>
          <a class="source" href="subscriptions_controller.html">subscriptions_controller.rb</a>
          <a class="source" href="updates_controller.html">updates_controller.rb</a>
          <a class="source" href="users_controller.html">users_controller.rb</a>
          <a class="source" href="webfinger_controller.html">webfinger_controller.rb</a>
          <a class="source" href="../models/author.html">author.rb</a>
          <a class="source" href="../models/authorization.html">authorization.rb</a>
          <a class="source" href="../models/feed.html">feed.rb</a>
          <a class="source" href="../models/notifier.html">notifier.rb</a>
          <a class="source" href="../models/update.html">update.rb</a>
          <a class="source" href="../models/user.html">user.rb</a>
      </div>
    </div>
  </div>
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>users_controller.rb</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-1'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-1">&#182;</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">index</span>
    <span class="n">set_params_page</span>
    <span class="vi">@authors</span> <span class="o">=</span> <span class="no">Author</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

    <span class="vi">@authors</span> <span class="o">=</span> <span class="vi">@authors</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">:page</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">,</span> <span class="ss">:per_page</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:per_page</span><span class="o">]</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">params</span><span class="o">[</span><span class="ss">:letter</span><span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">params</span><span class="o">[</span><span class="ss">:letter</span><span class="o">].</span><span class="n">empty?</span>
      <span class="n">set_pagination_buttons</span><span class="p">(</span><span class="vi">@authors</span><span class="p">,</span> <span class="ss">:letter</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:letter</span><span class="o">]</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="n">set_pagination_buttons</span><span class="p">(</span><span class="vi">@authors</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_case_insensitive_username</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">nil?</span>
      <span class="n">render</span> <span class="ss">:file</span> <span class="o">=&gt;</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="si">}</span><span class="s2">/public/404.html&quot;</span><span class="p">,</span> <span class="ss">:status</span> <span class="o">=&gt;</span> <span class="mi">404</span>
    <span class="k">elsif</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span> <span class="o">!=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span> <span class="c1"># case difference</span>
      <span class="n">redirect_to</span> <span class="s2">&quot;/users/</span><span class="si">#{</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">else</span>
      <span class="n">set_params_page</span>

      <span class="vi">@author</span>  <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">author</span>
      <span class="vi">@updates</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">updates</span>
      <span class="vi">@updates</span> <span class="o">=</span> <span class="vi">@updates</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">:page</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">,</span> <span class="ss">:per_page</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:per_page</span><span class="o">]</span><span class="p">)</span>

      <span class="n">set_pagination_buttons</span><span class="p">(</span><span class="vi">@updates</span><span class="p">)</span>

      <span class="n">headers</span><span class="o">[</span><span class="s1">&#39;Link&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;&lt;</span><span class="si">#{</span><span class="n">user_xrd_path</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">username</span><span class="p">)</span><span class="si">}</span><span class="s2">&gt;; rel=</span><span class="se">\&quot;</span><span class="s2">lrdd</span><span class="se">\&quot;</span><span class="s2">; type=</span><span class="se">\&quot;</span><span class="s2">application/xrd+xml</span><span class="se">\&quot;</span><span class="s2">&quot;</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">edit</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_case_insensitive_username</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-2'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-2">&#182;</a>
        </div>
        <p>While it might be cool to edit other people&rsquo;s profiles, we probably
shouldn&rsquo;t let you do that. We&rsquo;re no fun.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">if</span> <span class="vi">@user</span> <span class="o">==</span> <span class="n">current_user</span>
      <span class="n">render</span> <span class="ss">:edit</span>
    <span class="k">else</span>
      <span class="n">redirect_to</span> <span class="n">user_path</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">update</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_case_insensitive_username</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span> <span class="o">==</span> <span class="n">current_user</span>
      <span class="n">response</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">edit_user_profile</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">response</span> <span class="o">==</span> <span class="kp">true</span>

        <span class="k">unless</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">blank?</span> <span class="o">||</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email_confirmed</span></pre></div>
      </td>
    </tr>
    <tr id='section-3'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-3">&#182;</a>
        </div>
        <p>Generate same token as password reset&hellip;.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>          <span class="no">Notifier</span><span class="o">.</span><span class="n">send_confirm_email_notification</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="vi">@user</span><span class="o">.</span><span class="n">set_perishable_token</span><span class="p">)</span>
          <span class="n">flash</span><span class="o">[</span><span class="ss">:notice</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;A link to confirm your updated email address has been sent to </span><span class="si">#{</span><span class="vi">@user</span><span class="o">.</span><span class="n">email</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="k">else</span>
          <span class="n">flash</span><span class="o">[</span><span class="ss">:notice</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Profile saved!&quot;</span>
        <span class="k">end</span>

        <span class="n">redirect_to</span> <span class="n">user_path</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>

      <span class="k">else</span>
        <span class="n">flash</span><span class="o">[</span><span class="ss">:notice</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Profile could not be saved: </span><span class="si">#{</span><span class="n">response</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">render</span> <span class="ss">:edit</span>
      <span class="k">end</span>
    <span class="k">else</span>
      <span class="n">redirect_to</span> <span class="n">user_path</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">new</span>
    <span class="n">params</span><span class="o">[</span><span class="ss">:username</span><span class="o">]</span> <span class="o">=</span> <span class="n">session</span><span class="o">[</span><span class="ss">:nickname</span><span class="o">]</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">params</span><span class="o">[</span><span class="ss">:author</span><span class="o">]</span> <span class="o">=</span> <span class="no">Author</span><span class="o">.</span><span class="n">create_from_session!</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">root_url</span><span class="p">)</span>

    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span> <span class="n">params</span>

    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
      <span class="no">Authorization</span><span class="o">.</span><span class="n">create_from_session!</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="vi">@user</span><span class="p">)</span>

      <span class="n">flash</span><span class="o">[</span><span class="ss">:notice</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Thanks! You&#39;re all signed up with </span><span class="si">#{</span><span class="vi">@user</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2"> for your username.&quot;</span>
      <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">id</span>
      <span class="n">redirect_to</span> <span class="n">root_path</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="ss">:new</span>
    <span class="k">end</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-4'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-4">&#182;</a>
        </div>
        <p>uuuhhhh</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nf">create_from_email</span>
    <span class="n">u</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:email</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:email</span><span class="o">]</span><span class="p">,</span>
                    <span class="ss">:status</span> <span class="o">=&gt;</span> <span class="s2">&quot;unconfirmed&quot;</span><span class="p">)</span>
    <span class="n">u</span><span class="o">.</span><span class="n">set_perishable_token</span>

    <span class="k">if</span> <span class="n">development?</span>
      <span class="nb">puts</span> <span class="n">root_url</span> <span class="o">+</span> <span class="s2">&quot;/confirm/</span><span class="si">#{</span><span class="n">u</span><span class="o">.</span><span class="n">perishable_token</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">else</span>
      <span class="no">Notifier</span><span class="o">.</span><span class="n">send_signup_notification</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:email</span><span class="o">]</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">perishable_token</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-5'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-5">&#182;</a>
        </div>
        <p>This is pretty much the same thing as /feeds/your_feed_id, but we
wanted to have a really nice URL for it, and not just the ugly one.
Since it&rsquo;s only two lines, we don&rsquo;t bother to do a redirect, and
it&rsquo;s arguably better to display them as two different resources.
Whatevs.
Except we ARE doing a redirect??? /me shakes fist at steve</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nf">feed</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_case_insensitive_username</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span>
      <span class="n">redirect_to</span> <span class="s2">&quot;/feeds/</span><span class="si">#{</span><span class="n">user</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">.atom&quot;</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="ss">:file</span> <span class="o">=&gt;</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="si">}</span><span class="s2">/public/404.html&quot;</span><span class="p">,</span> <span class="ss">:status</span> <span class="o">=&gt;</span> <span class="mi">404</span>
    <span class="k">end</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-6'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-6">&#182;</a>
        </div>
        <p>Who do you think is a really neat person? This page will show it to the
world, so pick wisely!</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nf">following</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_case_insensitive_username</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>

    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">nil?</span>
      <span class="n">render</span> <span class="ss">:file</span> <span class="o">=&gt;</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="si">}</span><span class="s2">/public/404.html&quot;</span><span class="p">,</span> <span class="ss">:status</span> <span class="o">=&gt;</span> <span class="mi">404</span>
    <span class="k">elsif</span> <span class="vi">@user</span><span class="o">.</span><span class="n">username</span> <span class="o">!=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span> <span class="c1"># case difference</span>
      <span class="n">redirect_to</span> <span class="s2">&quot;/users/</span><span class="si">#{</span><span class="vi">@user</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2">/following&quot;</span>
    <span class="k">else</span>
      <span class="n">set_params_page</span>

      <span class="vi">@feeds</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">following</span>

      <span class="vi">@feeds</span> <span class="o">=</span> <span class="vi">@feeds</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">:page</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">,</span> <span class="ss">:per_page</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:per_page</span><span class="o">]</span><span class="p">,</span> <span class="ss">:order</span> <span class="o">=&gt;</span> <span class="ss">:id</span><span class="o">.</span><span class="n">desc</span><span class="p">)</span>

      <span class="n">set_pagination_buttons</span><span class="p">(</span><span class="vi">@feeds</span><span class="p">)</span>

      <span class="vi">@authors</span> <span class="o">=</span> <span class="vi">@feeds</span><span class="o">.</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="n">f</span><span class="o">.</span><span class="n">author</span><span class="p">}</span>

      <span class="k">if</span> <span class="vi">@user</span> <span class="o">==</span> <span class="n">current_user</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;You&#39;re following&quot;</span>
      <span class="k">else</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;@</span><span class="si">#{</span><span class="vi">@user</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2"> is following&quot;</span>
      <span class="k">end</span>

      <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
        <span class="nb">format</span><span class="o">.</span><span class="n">html</span> <span class="p">{</span> <span class="n">render</span> <span class="s2">&quot;users/list&quot;</span><span class="p">,</span> <span class="ss">:locals</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:title</span> <span class="o">=&gt;</span> <span class="n">title</span><span class="p">}</span> <span class="p">}</span>
        <span class="nb">format</span><span class="o">.</span><span class="n">json</span> <span class="p">{</span> <span class="n">render</span> <span class="ss">:json</span> <span class="o">=&gt;</span> <span class="vi">@authors</span> <span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-7'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-7">&#182;</a>
        </div>
        <p>This shows off how cool you are: I hope you&rsquo;ve got the biggest number of
followers. Only one way to find out&hellip;</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nf">followers</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_case_insensitive_username</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>

    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">nil?</span>
      <span class="n">render</span> <span class="ss">:file</span> <span class="o">=&gt;</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="si">}</span><span class="s2">/public/404.html&quot;</span><span class="p">,</span> <span class="ss">:status</span> <span class="o">=&gt;</span> <span class="mi">404</span>
    <span class="k">elsif</span> <span class="vi">@user</span><span class="o">.</span><span class="n">username</span> <span class="o">!=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span> <span class="c1"># case difference</span>
      <span class="n">redirect_to</span> <span class="s2">&quot;/users/</span><span class="si">#{</span><span class="vi">@user</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2">/followers&quot;</span>
    <span class="k">else</span>
      <span class="n">set_params_page</span>

      <span class="vi">@feeds</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">followers</span>

      <span class="vi">@feeds</span> <span class="o">=</span> <span class="vi">@feeds</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">:page</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">,</span> <span class="ss">:per_page</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:per_page</span><span class="o">]</span><span class="p">,</span> <span class="ss">:order</span> <span class="o">=&gt;</span> <span class="ss">:id</span><span class="o">.</span><span class="n">desc</span><span class="p">)</span>

      <span class="n">set_pagination_buttons</span><span class="p">(</span><span class="vi">@feeds</span><span class="p">)</span>

      <span class="vi">@authors</span> <span class="o">=</span> <span class="vi">@feeds</span><span class="o">.</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="n">f</span><span class="o">.</span><span class="n">author</span><span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-8'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-8">&#182;</a>
        </div>
        <p>build title</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">if</span> <span class="vi">@user</span> <span class="o">==</span> <span class="n">current_user</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Your followers&quot;</span>
      <span class="k">else</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;@</span><span class="si">#{</span><span class="vi">@user</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2">&#39;s followers&quot;</span>
      <span class="k">end</span>

      <span class="n">render</span> <span class="s2">&quot;users/list&quot;</span><span class="p">,</span> <span class="ss">:locals</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:title</span> <span class="o">=&gt;</span> <span class="n">title</span><span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">confirm_email</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="p">(</span><span class="ss">:perishable_token</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:token</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">nil?</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:notice</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Can&#39;t find User Account for this link.&quot;</span>
      <span class="n">redirect_to</span> <span class="s2">&quot;/&quot;</span>
    <span class="k">else</span>
      <span class="n">user</span><span class="o">.</span><span class="n">email_confirmed</span> <span class="o">=</span> <span class="kp">true</span>
      <span class="n">user</span><span class="o">.</span><span class="n">save</span></pre></div>
      </td>
    </tr>
    <tr id='section-9'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-9">&#182;</a>
        </div>
        <p>Register a session for the user</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:notice</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Email successfully confirmed.&quot;</span>
      <span class="n">redirect_to</span> <span class="s2">&quot;/&quot;</span>
    <span class="k">end</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-10'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-10">&#182;</a>
        </div>
        <p>Passwords can be reset by unauthenticated users by navigating to the forgot
password and page and submitting the email address they provided.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nf">forgot_password_new</span>
    <span class="n">render</span> <span class="s2">&quot;login/forgot_password&quot;</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-11'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-11">&#182;</a>
        </div>
        <p>We&rsquo;ve got a pretty solid forgotten password implementation. It&rsquo;s simple:
the email address is looked up, if no user is found an error is provided.
If a user is found a token is generated and an email is sent to the user
with the url to reset their password. Users are then redirected to the
confirmation page to prevent repost issues</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nf">forgot_password_create</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="p">(</span><span class="ss">:email</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:email</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">nil?</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:notice</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Your account could not be found, please check your email and try again.&quot;</span>
      <span class="n">render</span> <span class="s2">&quot;login/forgot_password&quot;</span>
    <span class="k">else</span>
      <span class="no">Notifier</span><span class="o">.</span><span class="n">send_forgot_password_notification</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">set_password_reset_token</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-12'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-12">&#182;</a>
        </div>
        <p>Redirect to try to avoid repost issues</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">session</span><span class="o">[</span><span class="ss">:fp_email</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span>
      <span class="n">redirect_to</span> <span class="s1">&#39;/forgot_password_confirm&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-13'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-13">&#182;</a>
        </div>
        <p>Forgot password confirmation screen, displays email address that the email
was sent to</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nf">forgot_password_confirm</span>
    <span class="vi">@email</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="ss">:fp_email</span><span class="p">)</span>
    <span class="n">render</span> <span class="s2">&quot;login/forgot_password_confirm&quot;</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">reset_password_new</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">logged_in?</span>
      <span class="n">redirect_to</span> <span class="s2">&quot;/forgot_password&quot;</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s2">&quot;login/password_reset&quot;</span>
    <span class="k">end</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-14'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-14">&#182;</a>
        </div>
        <p>Submitted passwords are checked for length and confirmation. If the user
does not have an email address they are required to provide one. Once the
password has been reset the user is redirected to /</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nf">reset_password_create</span>
    <span class="n">user</span> <span class="o">=</span> <span class="kp">nil</span>

    <span class="k">if</span> <span class="n">params</span><span class="o">[</span><span class="ss">:token</span><span class="o">]</span>
      <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="p">(</span><span class="ss">:perishable_token</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:token</span><span class="o">]</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">password_reset_sent</span><span class="o">.</span><span class="n">to_time</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">.</span><span class="n">days</span><span class="o">.</span><span class="n">ago</span>
        <span class="n">user</span> <span class="o">=</span> <span class="kp">nil</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">unless</span> <span class="n">user</span><span class="o">.</span><span class="n">nil?</span></pre></div>
      </td>
    </tr>
    <tr id='section-15'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-15">&#182;</a>
        </div>
        <p>XXX: yes, this is a code smell</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">if</span> <span class="n">params</span><span class="o">[</span><span class="ss">:password</span><span class="o">].</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">flash</span><span class="o">[</span><span class="ss">:notice</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Password must be present&quot;</span>
        <span class="n">redirect_to</span> <span class="s2">&quot;/reset_password/</span><span class="si">#{</span><span class="n">params</span><span class="o">[</span><span class="ss">:token</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span>
      <span class="k">end</span>

      <span class="k">if</span> <span class="n">params</span><span class="o">[</span><span class="ss">:password</span><span class="o">]</span> <span class="o">!=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:password_confirm</span><span class="o">]</span>
        <span class="n">flash</span><span class="o">[</span><span class="ss">:notice</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Passwords do not match&quot;</span>
        <span class="n">redirect_to</span> <span class="s2">&quot;/reset_password/</span><span class="si">#{</span><span class="n">params</span><span class="o">[</span><span class="ss">:token</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span>
      <span class="k">end</span>

      <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">nil?</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">[</span><span class="ss">:email</span><span class="o">].</span><span class="n">empty?</span>
          <span class="n">flash</span><span class="o">[</span><span class="ss">:notice</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Email must be provided&quot;</span>
          <span class="n">redirect_to</span> <span class="s2">&quot;/reset_password/</span><span class="si">#{</span><span class="n">params</span><span class="o">[</span><span class="ss">:token</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
          <span class="k">return</span>
        <span class="k">else</span>
          <span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:email</span><span class="o">]</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="n">user</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:password</span><span class="o">]</span>
      <span class="n">user</span><span class="o">.</span><span class="n">save</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:notice</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Password successfully set&quot;</span>
      <span class="n">redirect_to</span> <span class="s2">&quot;/&quot;</span>
    <span class="k">else</span>
      <span class="n">redirect_to</span> <span class="s2">&quot;/forgot_password&quot;</span>
    <span class="k">end</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-16'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-16">&#182;</a>
        </div>
        <p>Public reset password page, accessible via a valid token. Tokens are only
valid for 2 days and are unique to that user. The user is found using the
token and the reset password page is rendered</p>

      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nf">reset_password_with_token</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="p">(</span><span class="ss">:perishable_token</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:token</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">nil?</span> <span class="o">||</span> <span class="n">user</span><span class="o">.</span><span class="n">password_reset_sent</span><span class="o">.</span><span class="n">to_time</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">.</span><span class="n">days</span><span class="o">.</span><span class="n">ago</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:notice</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Your link is no longer valid, please request a new one.&quot;</span>
      <span class="n">redirect_to</span> <span class="s2">&quot;/forgot_password&quot;</span>
    <span class="k">else</span>
      <span class="vi">@token</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:token</span><span class="o">]</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="n">user</span>
      <span class="n">render</span> <span class="s2">&quot;login/password_reset&quot;</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
